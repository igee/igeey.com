<% @title = @venue.name %>

<% content_for :head do %>
  <script type="text/javascript" src="http://ditu.google.cn/maps/api/js?sensor=false"></script>
<% end %>

<div class="box">
  <div style="float:left;text-align:center;">
    <%= image_tag(@venue.cover.url,:class => "venue_cover") %>
    <br/>
    <span>
      <%= link_to "#{@venue.cover_file_name ? '更新' : '上传'}主题图",cover_venue_path(@venue),:class => "open_dialog",:title => "#{@venue.cover_file_name ? '更新' : '上传'}主题图" if logged_in? && @venue.creator == current_user%>
      　<%= link_to '更新信息',edit_venue_path(@venue),:id => 'update_info' if logged_in? && @venue.creator == current_user %>
    </span>
  </div>
  <div style="width:440px;_width:430px;height:122px;margin-left:180px">
    <div style="float:right;padding:2px 0"><%= raw(follow_to(@venue)) %></div>
    <h3><%= @venue.name%> <span><%= @venue.geo.full_name %></span></h3>
    <p><%= @venue.intro%></p>      
  </div>
</div>

<div class="box">
  <div style="width:127px;height:300px;float:right;background:#bbb;margin:10px 0;border:1px solid #aaa;border-left:0;border-bottom">
    <ul id="layer_list" style="margin:0">
      <li><%= link_to "位置",'#',:title => "position" ,:class => 'selected'%></li>
      <li><%= link_to "环境",'#',:title => "environment",:class => 'find_tagged_with' %></li>
      <li><%= link_to "交通",'#',:title => "traffic",:class => 'find_tagged_with'%></li>
      <li><%= link_to "人工建筑",'#',:title => "artificial",:class => 'find_tagged_with'%></li>
    </ul>
    <p style="font-size:12px;text-align:center">
    <%= link_to '修改位置',position_venue_path(@venue) if @venue.creator == current_user%>
    </p>
  </div>
  <div id="map_canvas" style="width:490px;height:300px;margin:10px 0 0; "></div>
  <div id="panel_list" style="width:600px;text-align:right;padding:10px 0">
    <%= link_to '添加标记',new_record_path(:action_id => 4,:venue_id => @venue.id),:title => "environment",:class => 'button'%>
  </div>
</div>

<div class="box" style="text-align:center;display:none" >
  <%= link_to '召集行动',(logged_in? ? "#{new_calling_path}?venue_id=#{@venue.id}" : signup_path),:class => "big_button open_dialog",:title => '召集行动'%>
  <%= link_to '记录行动',(logged_in? ? "#{new_record_path}?venue_id=#{@venue.id}" : signup_path),:class => "big_button open_dialog",:title => '记录行动'%>
</div>

<div class="box">  
  <h4>大家的行动:</h4>
  <%= render :partial => '/public/event', :collection => @timeline %>
</div>

<%= render :partial => '/photos/gallery' ,:locals => {:imageable => @venue}%>

<div class="box">
  <h4>论坛：
    　<%= image_tag "/images/icon/talk.gif",:class=>"icon"%>
    <span><%= link_to '发布话题',(logged_in? ? new_topic_path(:venue_id => @venue.id) : signup_path),:class=>"open_dialog",:title=>'发布话题'%></span>
  </h4>
  <%= render :partial => '/public/topic' ,:collection => @topics%>
</div>

<% content_for :sidebar do %>
  <div class="box">
    <h4>获得服务统计：</h4>
    <div id="record_counters">
      <% [[@venue.time_count,'志愿小时'],[@venue.goods_count,'物资捐赠'],[@venue.online_count,'线上行动']].each do |counter_list|%>
        <div class="record_counter_wrapper">
          <h4><%= counter_list[1] %></h4>
          <h2 class="record_counter"><%= counter_list[0] %></h2>
        </div>
      <%end%>
    </div>
  </div>
  
  <%= render :partial => "/public/followers" %>
<% end %>


<% content_for :extension do %>
  <script type="text/javascript">
    function initialize() {
      var latlng = new google.maps.LatLng(<%= "#{@venue.latitude || 35.0},#{@venue.longitude || 105.0}"%>)
      var myOptions = {
        zoom: 16 ,
        center: latlng,
        mapTypeId: google.maps.MapTypeId.ROADMAP
      };
      map = new google.maps.Map(document.getElementById("map_canvas"), myOptions);
      
      markers = new Array();
      markers['position'] = new Array();
      markers['position'][0] = new google.maps.Marker({
        map: map,
        position: map.getCenter(),
        title: '<%= @venue.name %>'
      });
      position = markers['position'][0]
      current_layer = markers['position']
      
      $('.find_tagged_with').each(function(){
        var tag = $(this).html()
        var title = $(this).attr('title')
        markers[title] = new Array();
        $.getJSON(('<%= records_venue_path(@venue,:format => :json)%>?tag=' + tag ) , function(data){
          $.each(data, function(i,item){
              markers[title][i] = new google.maps.Marker({
                icon: "/images/marker/" + item.record.slug + ".png",
                position: new google.maps.LatLng(parseFloat(item.record.latitude), parseFloat(item.record.longitude)),
                title: item.record.name,
                map: null
              });
              google.maps.event.addListener(markers[title][i], "click", function(){
                $.ajax({
                  url:"/records/" + item.record.id + ".xml",
                  success:function(data, textStatus, XMLHttpRequest){new google.maps.InfoWindow({content:XMLHttpRequest.responseText}).open(map,markers[title][i]);},
                  dataType:'xml'
                })
              })
            });
        });
      });
      
      marker = new google.maps.Marker({
        position: map.getCenter(), 
        title: "标记坐标",
        draggable: true,
        zindex: 100
      });
    }; //initialize_end()
    
    function switch_layer(tag){
      for(var i=0; i< current_layer.length; i++){
        current_layer[i].setMap(null);
      };
      for(var i=0; i< markers[tag].length; i++){
        markers[tag][i].setMap(map);
      };
      current_layer = markers[tag];
    }
    
    function cancel_edit(){
      marker.setMap(null);
      position.setDraggable(false);
      position.setIcon("http://maps.gstatic.cn/intl/zh-CN_cn/mapfiles/marker.png");
      $('#panel_list .submit').hide();
      $('#panel_list a').show();
    }

    function submit_marker(){
      var slug = marker.getIcon().slice(15,-4);
      var url = '/records/new?latitude=' + marker.getPosition().lat() + '&longitude=' + marker.getPosition().lng() + '&slug=' + slug + '&venue_id=<%=@venue.id%>&action_id=4'
      window.location = url
    }
    
    $(document).ready(function(){
      //use javascript to check whether there are news for performance
      initialize();
      $('#layer_list>li>a').click(function(){
        switch_layer($(this).attr('title'));
        cancel_edit();
        $('#cutline_list').hide();
        $('#layer_list>li>a.selected').removeClass('selected')
        $('#panel_list li').hide();
        $('#panel_' + $(this).attr('title')).show();
        $(this).addClass('selected');
        return false;
        });
      
      $('#edit_position').click(function(){
        position.setIcon("http://maps.gstatic.cn/intl/zh-CN_cn/mapfiles/marker_green.png");
        position.setDraggable(true);
        $(this).hide();
        $('#panel_list .submit').show();
        return false;
        });
      
      $('#update_position').click(function(){
        $('#venue_latitude').val(marker.getPosition().lat());
        $('#venue_longitude').val(marker.getPosition().lng());
        })
    
    });  
  </script>
<% end %>